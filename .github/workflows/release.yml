name: Build VSIX on version bump

on:
  push:
    branches:
      - master

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Detect version change
        id: version_check
        run: |
          prev_version=$(git show HEAD^:package.json | node -pe "require('fs').readFileSync(0,'utf8') && JSON.parse(require('fs').readFileSync(0,'utf8')).version")
          curr_version=$(node -pe "require('./package.json').version")
          echo "previous=$prev_version" >> "$GITHUB_OUTPUT"
          echo "current=$curr_version" >> "$GITHUB_OUTPUT"
          if [ "$prev_version" = "$curr_version" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Install dependencies
        if: steps.version_check.outputs.changed == 'true'
        run: npm ci

      - name: Build
        if: steps.version_check.outputs.changed == 'true'
        run: npm run compile

      - name: Install vsce
        if: steps.version_check.outputs.changed == 'true'
        run: npm install -g @vscode/vsce

      - name: Package extension
        if: steps.version_check.outputs.changed == 'true'
        run: vsce package --out context-aware-suggestions.vsix

      - name: Create release
        if: steps.version_check.outputs.changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: context-aware-suggestions.vsix
          tag_name: v${{ steps.version_check.outputs.current }}
          name: v${{ steps.version_check.outputs.current }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
